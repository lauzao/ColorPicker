import net.minecraft.client.gui.widget.AbstractWidget;
import net.minecraft.client.util.math.DrawContext;
import org.lwjgl.glfw.GLFW;
import java.awt.Color;

public class ColorPickerWidget extends AbstractWidget {
    private int hue;
    private float saturation;
    private float brightness;

    private final int gradientWidth = 200;
    private final int gradientHeight = 200;
    private final int barWidth = 20;
    private final int barHeight = gradientHeight;

    public ColorPickerWidget(int x, int y, int width, int height) {
        super(x, y, width, height);
        this.hue = 0;
        this.saturation = 1.0f;
        this.brightness = 1.0f;
    }

    @Override
    public void render(DrawContext context, int mouseX, int mouseY, float delta) {
        drawColorGradient(context, x, y, gradientWidth, gradientHeight);
        drawColorBar(context, x + gradientWidth + 5, y, barWidth, barHeight);
        
        if (isMouseOverGradient(mouseX, mouseY) && GLFW.glfwGetMouseButton(GLFW.glfwGetCurrentContext(), GLFW.GLFW_MOUSE_BUTTON_1) == GLFW.GLFW_PRESS) {
            updateSaturationBrightness(mouseX, mouseY);
        }

        if (isMouseOverColorBar(mouseX, mouseY) && GLFW.glfwGetMouseButton(GLFW.glfwGetCurrentContext(), GLFW.GLFW_MOUSE_BUTTON_1) == GLFW.GLFW_PRESS) {
            updateHue(mouseY);
        }

        super.render(context, mouseX, mouseY, delta);
    }

    private void drawColorGradient(DrawContext context, int x, int y, int width, int height) {
        for (int i = 0; i < width; i++) {
            for (int j = 0; j < height; j++) {
                float sat = (float) i / width;
                float bri = 1.0f - (float) j / height;
                int color = Color.HSBtoRGB((float) hue / 360f, sat, bri);
                context.fill(x + i, y + j, x + i + 1, y + j + 1, color);
            }
        }
    }

    private void drawColorBar(DrawContext context, int x, int y, int width, int height) {
        for (int j = 0; j < height; j++) {
            float hueValue = (float) j / height;
            int color = Color.HSBtoRGB(hueValue, 1.0f, 1.0f);
            context.fill(x, y + j, x + width, y + j + 1, color);
        }
    }

    private boolean isMouseOverGradient(int mouseX, int mouseY) {
        return mouseX >= x && mouseX < x + gradientWidth && mouseY >= y && mouseY < y + gradientHeight;
    }

    private boolean isMouseOverColorBar(int mouseX, int mouseY) {
        return mouseX >= x + gradientWidth + 5 && mouseX < x + gradientWidth + 5 + barWidth && mouseY >= y && mouseY < y + barHeight;
    }

    private void updateSaturationBrightness(int mouseX, int mouseY) {
        saturation = Math.max(0, Math.min(1, (float) (mouseX - x) / gradientWidth));
        brightness = Math.max(0, Math.min(1, 1.0f - (float) (mouseY - y) / gradientHeight));
    }

    private void updateHue(int mouseY) {
        hue = Math.max(0, Math.min(360, (int) ((float) (mouseY - y) / barHeight * 360)));
    }

    public int getSelectedColor() {
        return Color.HSBtoRGB((float) hue / 360f, saturation, brightness);
    }
}
